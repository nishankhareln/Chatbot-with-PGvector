<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>RAG Assistant - Document Q&A System</title>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "sidebar-dark": "#161b22",
                        "card-dark": "#1e232e",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem", 
                        "lg": "0.5rem", 
                        "xl": "0.75rem", 
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
        
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #135bec;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #374151;
            border-radius: 2px;
        }

        /* Loading animation */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-dot {
            animation: bounce 1s ease-in-out infinite;
        }
        .delay-100 {
            animation-delay: 0.1s;
        }
        .delay-200 {
            animation-delay: 0.2s;
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Mobile sidebar */
        .sidebar-mobile {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-mobile.open {
            transform: translateX(0);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white h-screen overflow-hidden flex flex-col md:flex-row">

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" multiple accept=".pdf,.txt,.md" style="display: none;" />

    <!-- Mobile Header -->
    <div class="md:hidden flex items-center justify-between p-4 bg-sidebar-dark border-b border-gray-800">
        <span class="text-xl font-bold tracking-tight">RAG Assistant</span>
        <button id="mobileMenuBtn" class="text-gray-400 hover:text-white">
            <span class="material-symbols-outlined">menu</span>
        </button>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

    <!-- Sidebar Section -->
    <aside id="sidebar" class="sidebar-mobile md:translate-x-0 fixed md:relative z-50 md:z-auto md:flex flex-col w-80 h-full bg-sidebar-dark border-r border-gray-800 flex-shrink-0">
        <!-- Sidebar Header -->
        <div class="p-6 pb-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-primary flex items-center justify-center shadow-lg shadow-primary/30">
                        <span class="material-symbols-outlined text-white text-lg">smart_toy</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold leading-tight">RAG Assistant</h1>
                        <div class="flex items-center gap-1.5 mt-1">
                            <span id="statusDot" class="w-2 h-2 rounded-full bg-gray-500"></span>
                            <span id="statusText" class="text-xs text-gray-400 font-medium">Connecting...</span>
                        </div>
                    </div>
                </div>
                <button id="closeSidebarBtn" class="md:hidden text-gray-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-4 py-2 space-y-6">
            <!-- Upload Section -->
            <div class="space-y-3">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider pl-1">Knowledge Base</h3>
                <div id="uploadBox" class="border-2 border-dashed border-gray-700 hover:border-gray-600 rounded-xl p-6 flex flex-col items-center justify-center text-center transition-colors cursor-pointer group bg-gray-900/30">
                    <span class="material-symbols-outlined text-gray-500 group-hover:text-primary mb-2 transition-colors">cloud_upload</span>
                    <p class="text-sm font-medium text-gray-300">Click to upload</p>
                    <p class="text-xs text-gray-500 mt-1">PDF, TXT, or Markdown files</p>
                </div>
            </div>

            <!-- Documents List -->
            <div class="space-y-2">
                <div class="flex items-center justify-between px-1">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        Documents (<span id="docCount">0</span>)
                    </h3>
                    <button id="refreshBtn" class="text-xs text-primary hover:text-primary/80 font-medium">
                        Refresh
                    </button>
                </div>
                <ul id="documentsList" class="space-y-1">
                    <!-- Documents will be loaded here -->
                    <li class="text-sm text-gray-500 text-center py-4">No documents uploaded yet</li>
                </ul>
            </div>

            <!-- Configuration -->
            <div class="space-y-4 pt-4 border-t border-gray-800">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider pl-1">Configuration</h3>
                
                <!-- Document Scope -->
                <div class="space-y-1.5">
                    <label class="text-sm text-gray-300 font-medium">Document Scope</label>
                    <div class="relative">
                        <select id="documentScope" class="w-full bg-gray-800 border border-gray-700 text-gray-200 text-sm rounded-lg focus:ring-primary focus:border-primary block p-2.5 appearance-none">
                            <option value="">All Documents</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                            <span class="material-symbols-outlined text-sm">expand_more</span>
                        </div>
                    </div>
                </div>

                <!-- Top K Slider -->
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="text-sm text-gray-300 font-medium">Context Limit (Top K)</label>
                        <span id="topKValue" class="text-xs font-mono bg-primary/20 text-primary px-1.5 py-0.5 rounded">3</span>
                    </div>
                    <input id="topKSlider" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" 
                           max="10" min="1" type="range" value="3"/>
                    <div class="flex justify-between text-xs text-gray-500 font-mono">
                        <span>1</span>
                        <span>10</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Footer -->
        <div class="p-4 border-t border-gray-800">
            <div class="text-xs text-gray-500 text-center">
                <p>Powered by RAG Architecture</p>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col h-full relative">
        <!-- Header -->
        <header class="hidden md:flex items-center justify-between px-8 py-4 bg-background-dark/80 backdrop-blur border-b border-gray-800 z-10 sticky top-0">
            <div class="flex items-center gap-2">
                <h2 class="text-lg font-semibold text-white">Chat</h2>
                <span class="px-2 py-0.5 rounded bg-gray-800 text-xs text-gray-400 border border-gray-700">AI Powered</span>
            </div>
            <div class="flex items-center gap-3">
                <button id="exportBtn" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-800 text-sm text-white hover:bg-gray-700 border border-gray-700 transition-colors">
                    <span class="material-symbols-outlined text-sm">ios_share</span>
                    Export
                </button>
                <button id="clearChatBtn" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm text-red-400 hover:bg-red-400/10 transition-colors">
                    <span class="material-symbols-outlined text-sm">delete_sweep</span>
                    Clear Chat
                </button>
            </div>
        </header>

        <!-- Chat Area -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 scroll-smooth" id="chatContainer">
            <!-- Welcome State -->
            <div id="welcomeState" class="h-full flex flex-col items-center justify-center opacity-40">
                <span class="material-symbols-outlined text-6xl mb-4">chat_bubble_outline</span>
                <p class="text-xl font-medium">How can I help you today?</p>
                <p class="text-sm text-gray-500 mt-2">Upload documents and start asking questions</p>
            </div>

            <!-- Messages will be added here -->
            
            <!-- Spacer for bottom input -->
            <div class="h-24"></div>
        </div>

        <!-- Sticky Input Area -->
        <div class="absolute bottom-0 w-full bg-gradient-to-t from-background-dark via-background-dark to-transparent pt-10 pb-6 px-4 md:px-8">
            <div class="max-w-4xl mx-auto relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-primary/50 to-indigo-500/50 rounded-xl opacity-30 group-focus-within:opacity-100 transition duration-500 blur-sm"></div>
                <div class="relative bg-[#1a1f2b] rounded-xl shadow-2xl flex flex-col border border-gray-700 overflow-hidden">
                    <textarea id="messageInput" 
                              class="w-full bg-transparent border-0 text-white placeholder-gray-500 focus:ring-0 px-4 py-3 resize-none max-h-40 overflow-y-auto" 
                              placeholder="Ask anything about your documents..." 
                              rows="1" 
                              style="min-height: 52px;"></textarea>
                    <div class="flex justify-between items-center px-2 pb-2">
                        <div class="flex items-center gap-1">
                            <span class="text-xs text-gray-600 px-2">Type your question</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500 mr-2 hidden md:inline-block">Press Enter to send</span>
                            <button id="sendButton" 
                                    class="bg-primary hover:bg-blue-600 text-white p-1.5 rounded-lg transition-colors shadow-lg shadow-primary/20 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="material-symbols-outlined text-[20px]">arrow_upward</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-center text-[10px] text-gray-600 mt-2">AI can make mistakes. Please verify important information.</p>
        </div>
    </main>

    <!-- Toast Notification (Hidden by default) -->
    <div id="toast" class="fixed top-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg border border-gray-700 hidden z-50">
        <div class="flex items-center gap-2">
            <span id="toastIcon" class="material-symbols-outlined text-sm"></span>
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const API_BASE = "http://localhost:8000";
        
        // ========================================
        // DOM ELEMENTS
        // ========================================
        const fileInput = document.getElementById("fileInput");
        const uploadBox = document.getElementById("uploadBox");
        const documentsList = document.getElementById("documentsList");
        const docCount = document.getElementById("docCount");
        const documentScope = document.getElementById("documentScope");
        const topKSlider = document.getElementById("topKSlider");
        const topKValue = document.getElementById("topKValue");
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const chatContainer = document.getElementById("chatContainer");
        const welcomeState = document.getElementById("welcomeState");
        const clearChatBtn = document.getElementById("clearChatBtn");
        const refreshBtn = document.getElementById("refreshBtn");
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        const toast = document.getElementById("toast");
        const toastIcon = document.getElementById("toastIcon");
        const toastMessage = document.getElementById("toastMessage");
        const exportBtn = document.getElementById("exportBtn");
        const mobileMenuBtn = document.getElementById("mobileMenuBtn");
        const closeSidebarBtn = document.getElementById("closeSidebarBtn");
        const sidebar = document.getElementById("sidebar");
        const mobileOverlay = document.getElementById("mobileOverlay");

        // ========================================
        // STATE (In-memory storage)
        // ========================================
        let documents = [];
        let currentDocumentId = null;
        let topK = 3;
        let chatHistory = [];
        let isProcessing = false;

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        function showToast(message, type = 'info') {
            const icons = {
                success: 'check_circle',
                error: 'error',
                info: 'info',
                warning: 'warning'
            };
            
            toastIcon.textContent = icons[type] || icons.info;
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // MOBILE MENU FUNCTIONS
        // ========================================
        
        function openMobileSidebar() {
            sidebar.classList.add('open');
            mobileOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileSidebar() {
            sidebar.classList.remove('open');
            mobileOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // ========================================
        // API FUNCTIONS
        // ========================================
        
        async function checkBackendHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    statusDot.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
                    statusText.textContent = 'System Ready';
                    return true;
                }
            } catch (error) {
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                statusText.textContent = 'Backend Offline';
                return false;
            }
        }

        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE}/documents`);
                const data = await response.json();
                documents = data.documents || [];
                
                renderDocumentsList();
                updateDocumentScope();
                docCount.textContent = documents.length;
                
            } catch (error) {
                console.error('Error loading documents:', error);
                showToast('Failed to load documents', 'error');
            }
        }

        function renderDocumentsList() {
            if (documents.length === 0) {
                documentsList.innerHTML = '<li class="text-sm text-gray-500 text-center py-4">No documents uploaded yet</li>';
                return;
            }

            documentsList.innerHTML = documents.map(doc => `
                <li class="group flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors cursor-pointer">
                    <div class="flex items-center justify-center w-8 h-8 rounded bg-gray-800 text-gray-400 group-hover:text-white">
                        <span class="material-symbols-outlined text-lg">
                            ${doc.file_type === 'pdf' ? 'description' : 'article'}
                        </span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-200 truncate">${escapeHTML(doc.filename)}</p>
                        <p class="text-xs text-gray-500">${formatFileSize(doc.file_size)} â€¢ ${formatDate(doc.uploaded_at)}</p>
                    </div>
                    <div class="flex opacity-0 group-hover:opacity-100 transition-opacity gap-1">
                        <button onclick="downloadDocument(${doc.id})" class="text-gray-500 hover:text-blue-400 p-1 rounded hover:bg-white/10" title="Download">
                            <span class="material-symbols-outlined text-[18px]">download</span>
                        </button>
                        <button onclick="deleteDocument(${doc.id})" class="text-gray-500 hover:text-red-400 p-1 rounded hover:bg-white/10" title="Delete">
                            <span class="material-symbols-outlined text-[18px]">delete</span>
                        </button>
                    </div>
                </li>
            `).join('');
        }

        function updateDocumentScope() {
            documentScope.innerHTML = '<option value="">All Documents</option>';
            documents.forEach(doc => {
                documentScope.innerHTML += `<option value="${doc.id}">${escapeHTML(doc.filename)}</option>`;
            });
        }

        async function uploadDocuments(files) {
            const formData = new FormData();
            
            for (const file of files) {
                formData.append("files", file);
            }

            try {
                showToast(`Uploading ${files.length} file(s)...`, 'info');
                
                const response = await fetch(`${API_BASE}/upload`, {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`Successfully uploaded ${data.total_documents} document(s)`, 'success');
                    await loadDocuments();
                } else {
                    showToast(`Upload failed: ${data.detail}`, 'error');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                showToast('Upload failed. Check backend connection.', 'error');
            }
        }

        async function downloadDocument(docId) {
            try {
                window.open(`${API_BASE}/document/${docId}/download`, '_blank');
                showToast('Download started', 'success');
            } catch (error) {
                showToast('Download failed', 'error');
            }
        }

        async function deleteDocument(docId) {
            if (!confirm('Are you sure you want to delete this document?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/document/${docId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('Document deleted', 'success');
                    await loadDocuments();
                } else {
                    showToast('Delete failed', 'error');
                }
            } catch (error) {
                showToast('Delete failed', 'error');
            }
        }

        async function sendMessage() {
            const question = messageInput.value.trim();
            if (!question || isProcessing) return;

            // Check if documents exist
            if (documents.length === 0) {
                showToast('Please upload a document first', 'warning');
                return;
            }

            // Prevent multiple simultaneous requests
            isProcessing = true;

            // Hide welcome state
            welcomeState.style.display = 'none';

            // Add user message
            addUserMessage(question);
            
            // Store in chat history
            chatHistory.push({
                role: 'user',
                content: question,
                timestamp: new Date().toISOString()
            });

            messageInput.value = "";
            sendButton.disabled = true;

            // Add loading indicator
            const loadingId = addLoadingMessage();

            try {
                const response = await fetch(`${API_BASE}/chat`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        question: question,
                        document_id: currentDocumentId || null,
                        top_k: topK
                    })
                });

                const data = await response.json();

                // Remove loading indicator
                removeLoadingMessage(loadingId);

                if (response.ok) {
                    // Add AI response
                    addAIMessage(data.answer, data.sources);
                    
                    // Store in chat history
                    chatHistory.push({
                        role: 'assistant',
                        content: data.answer,
                        sources: data.sources,
                        timestamp: new Date().toISOString()
                    });
                } else {
                    showToast(`Error: ${data.detail}`, 'error');
                    addAIMessage(`Sorry, I encountered an error: ${data.detail}`, []);
                }
                
            } catch (error) {
                removeLoadingMessage(loadingId);
                console.error('Chat error:', error);
                showToast('Failed to get response. Check backend connection.', 'error');
                addAIMessage('Sorry, I could not connect to the backend. Please check if the server is running.', []);
            } finally {
                sendButton.disabled = false;
                isProcessing = false;
                messageInput.focus();
            }
        }

        // ========================================
        // UI RENDERING FUNCTIONS
        // ========================================
        
        function addUserMessage(text) {
            const messageHTML = `
                <div class="flex justify-end w-full fade-in">
                    <div class="flex max-w-3xl items-start gap-3 flex-row-reverse">
                        <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0 border border-gray-600">
                            <span class="material-symbols-outlined text-sm text-gray-300">person</span>
                        </div>
                        <div class="bg-primary/20 border border-primary/20 text-white rounded-2xl rounded-tr-sm px-5 py-3.5 shadow-sm">
                            <p class="text-sm md:text-base leading-relaxed">${escapeHTML(text)}</p>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.insertAdjacentHTML('beforeend', messageHTML);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoadingMessage() {
            const loadingId = 'loading-' + Date.now();
            const loadingHTML = `
                <div id="${loadingId}" class="flex w-full fade-in">
                    <div class="flex max-w-3xl items-start gap-4">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary to-indigo-600 flex items-center justify-center flex-shrink-0 shadow-lg shadow-primary/20">
                            <span class="material-symbols-outlined text-sm text-white">smart_toy</span>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="w-2 h-2 rounded-full bg-gray-500 animate-bounce-dot"></span>
                            <span class="w-2 h-2 rounded-full bg-gray-500 animate-bounce-dot delay-100"></span>
                            <span class="w-2 h-2 rounded-full bg-gray-500 animate-bounce-dot delay-200"></span>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.insertAdjacentHTML('beforeend', loadingHTML);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingId;
        }

        function removeLoadingMessage(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        function addAIMessage(answer, sources) {
            const sourcesHTML = sources && sources.length > 0 ? `
                <div class="w-full mt-3">
                    <details class="group bg-gray-900/50 border border-gray-800 rounded-lg overflow-hidden transition-all duration-300">
                        <summary class="flex items-center justify-between p-3 cursor-pointer hover:bg-gray-800/50 transition-colors select-none">
                            <div class="flex items-center gap-2 text-xs font-semibold text-gray-400 uppercase tracking-wide">
                                <span class="material-symbols-outlined text-base">library_books</span>
                                Retrieval Sources (${sources.length})
                            </div>
                            <span class="material-symbols-outlined text-gray-500 transform group-open:rotate-180 transition-transform text-sm">expand_more</span>
                        </summary>
                        <div class="p-3 pt-0 grid gap-3 grid-cols-1 md:grid-cols-2">
                            ${sources.map((source, idx) => {
                                const scoreClass = source.similarity > 0.8 ? 'bg-green-500/10 text-green-400 border-green-500/20' : 
                                                   source.similarity > 0.6 ? 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20' :
                                                   'bg-gray-500/10 text-gray-400 border-gray-500/20';
                                
                                return `
                                    <div class="bg-gray-800/40 border border-gray-700/50 rounded-md p-3 hover:border-primary/40 transition-colors">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2 truncate flex-1 mr-2">
                                                <span class="material-symbols-outlined text-gray-500 text-sm">description</span>
                                                <span class="text-xs font-medium text-gray-300 truncate"

                                                <span class="text-xs font-medium text-gray-300 truncate">${escapeHTML(source.filename)}</span>
                                            </div>
                                            <span class="text-[10px] font-mono ${scoreClass} px-1.5 py-0.5 rounded border whitespace-nowrap">
                                                ${(source.similarity * 100).toFixed(0)}%
                                            </span>
                                        </div>
                                        <p class="text-xs text-gray-400 leading-relaxed line-clamp-3 font-mono">
                                            ${escapeHTML(source.text)}
                                        </p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </details>
                </div>
            ` : '';

            const messageHTML = `
                <div class="flex w-full fade-in">
                    <div class="flex max-w-3xl items-start gap-4">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary to-indigo-600 flex items-center justify-center flex-shrink-0 shadow-lg shadow-primary/20">
                            <span class="material-symbols-outlined text-sm text-white">smart_toy</span>
                        </div>
                        <div class="flex flex-col gap-3 w-full">
                            <div class="bg-card-dark border border-gray-800 text-gray-100 rounded-2xl rounded-tl-sm px-6 py-5 shadow-sm">
                                <p class="text-sm md:text-base leading-relaxed whitespace-pre-wrap">${escapeHTML(answer)}</p>
                            </div>
                            ${sourcesHTML}
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.insertAdjacentHTML('beforeend', messageHTML);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        
        uploadBox.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', async () => {
            if (fileInput.files.length > 0) {
                await uploadDocuments(fileInput.files);
                fileInput.value = '';
            }
        });

        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        topKSlider.addEventListener('input', (e) => {
            topK = parseInt(e.target.value);
            topKValue.textContent = topK;
        });

        documentScope.addEventListener('change', (e) => {
            currentDocumentId = e.target.value ? parseInt(e.target.value) : null;
        });

        clearChatBtn.addEventListener('click', () => {
            if (confirm('Clear all messages?')) {
                const messages = chatContainer.querySelectorAll('.fade-in');
                messages.forEach(msg => msg.remove());
                welcomeState.style.display = 'flex';
                chatHistory = [];
            }
        });

        refreshBtn.addEventListener('click', loadDocuments);

        mobileMenuBtn.addEventListener('click', openMobileSidebar);
        closeSidebarBtn.addEventListener('click', closeMobileSidebar);
        mobileOverlay.addEventListener('click', closeMobileSidebar);

        exportBtn.addEventListener('click', () => {
            if (chatHistory.length === 0) {
                showToast('No chat history to export', 'warning');
                return;
            }
            
            const dataStr = JSON.stringify(chatHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `chat-history-${new Date().toISOString()}.json`;
            link.click();
            showToast('Chat exported successfully', 'success');
        });

        // ========================================
        // INITIALIZATION
        // ========================================
        
        (async function init() {
            console.log('ðŸš€ Initializing RAG Assistant...');
            await checkBackendHealth();
            await loadDocuments();
            messageInput.focus();
            console.log('âœ… Initialization complete');
        })();
    </script>
</body>
</html>